<style>
	#header {
		font-size: 4.5rem;
		font-family: Arial, sans-serif;
		font-weight: 600;
		text-align: center;
		letter-spacing: .25rem;
		margin-bottom: 1.5rem;
	}
	
	body {
		margin: 2rem;
		background-color: efefef;
		text-align: center;
	}
		
	#gimme {
		padding: 1rem 3rem 1rem 3rem;
		font-size: 1.5rem;
		font-family: Arial, sans-serif;
		font-weight: 600;
		border: 3px solid black;
		box-shadow: 5px 5px #aaaaaa;
		cursor: pointer;
		letter-spacing: .2rem;
		outline: none;
	}
	
	#save {
		padding: 1rem 3rem 1rem 3rem;
		font-size: 1.5rem;
		font-family: Arial, sans-serif;
		font-weight: 600;
		border: 3px solid black;
		box-shadow: 5px 5px #aaaaaa;
		cursor: pointer;
		letter-spacing: .2rem;
		display: none;
		outline: none;
	}
	
	#friendcontainer {
		padding: 3rem; 
		margin: 0 auto;
		margin-bottom: 3rem;
		border: 3px solid black;
		max-width: 450px;
		min-width: 450px;
		min-height: 450px;
		display: none;
	}

	#seedcontainer {
		display: none;
	}
	
	#seedlabel {
		padding: 0rem 1rem 0rem 1rem;
		font-size: 1.5rem;
		font-family: Arial, sans-serif;
		font-weight: 600;
		letter-spacing: .12rem;
	}
	
	#seedtxt {
		margin-bottom: 2rem;
		border: 3px solid black;
		font-size: 1.3rem;
		font-family: Arial, sans-serif;
		font-weight: 600;
		box-shadow: 3px 3px #aaaaaa;
		letter-spacing: .11rem;
		outline: none;
	}
	
	#yournewbestfriend {
		max-width: 450px;
		display: none;
	}
	
	@keyframes zoomIn {
		0% {
			opacity: 0;
			transform: scale(0);
		}
		100% {
			opacity: 1;
			transform: scale(1);
		}
	}
	
	@keyframes zoomOut {
		0% {
			opacity: 1;
			transform: scale(1);
		}
		100% {
			opacity: 0;
			transform: scale(0);
		}
	}
	
	
	@keyframes rotateIn {
		0% {
			transform: rotate(-60deg);
		}
		
		5% {
			transform: rotate(-65deg);
		}
		
		55% {
			transform: rotate(3deg);
		}
		
		100% {
			transform: rotate(0deg);
		}
	}
	
	@keyframes rotateLeft {
		0% {
			transform: rotate(0deg);
		}
		55% {
			transform: rotate(-3deg);
		}
		100% {
			transform: rotate(0deg);
		}
	}
	
	@keyframes rotateRight {
		0% {
			transform: rotate(0deg);
		}
		55% {
			transform: rotate(3deg);
		}
		100% {
			transform: rotate(0deg);
		}
	}


	@keyframes rotateInFast {
		0% {
			opacity: 0;
			transform: rotate(-10deg);
		}
		
		3% {
			transform: scale(1.1) rotate(-15deg);
		}
		
		100% {
			opacity: 1;
			transform: scale(1) rotate(0deg);
		}
	}

	
	@keyframes rotateOut {
		0% {
			opacity: 1;
			transform: scale(1) rotate(0deg);
		}
					
		60% {
			opacity: 0;
			transform: scale(0) rotate(-520deg);
		}
		
		100% {
			opacity: 0;
			transform: scale(0) rotate(-520deg);
		}
	}


	.zoomingIn {
		animation: zoomIn 1s forwards; 
	}
	
	.zoomingOut {
		animation: zoomOut 1s forwards; 
	}
	
	.rot8in {
		animation: rotateIn 1s forwards;
	}

	.rot8infast {
		animation: rotateInFast 0.35s forwards;
	}

	.rot8out {
		animation: rotateOut 2s ease forwards; 
	}
	
	.rot8left {
		animation: rotateLeft 0.23s forwards;
	}
	
	.rot8right {
		animation: rotateRight 0.23s forwards;
	}
	
	#canvas {
		display: none;
	}

</style>

<title>MARE GENERATOR</title>

<body>
	<p id="header">MARE Generator</p>
	<div id="friendcontainer">
			<object id="yournewbestfriend" type="image/svg+xml" data="real.svg" width="450" height="450">
			</object>
	</div>
	
	<div id="seedcontainer">
		<label id="seedlabel" for="serverURL">Seed:</label>
		<input type="text" id="seedtxt" name="seedtxt"><br/>
	</div>
	
	<button id="gimme">I want a friend.</button>
	<button id="save">Share my mare</button>

	<canvas id="canvas" width="450" height="450"></canvas>

</body>

<script>
//https://github.com/davidbau/seedrandom
!function(f,a,c){var s,l=256,p="random",d=c.pow(l,6),g=c.pow(2,52),y=2*g,h=l-1;function n(n,t,r){function e(){for(var n=u.g(6),t=d,r=0;n<g;)n=(n+r)*l,t*=l,r=u.g(1);for(;y<=n;)n/=2,t/=2,r>>>=1;return(n+r)/t}var o=[],i=j(function n(t,r){var e,o=[],i=typeof t;if(r&&"object"==i)for(e in t)try{o.push(n(t[e],r-1))}catch(n){}return o.length?o:"string"==i?t:t+"\0"}((t=1==t?{entropy:!0}:t||{}).entropy?[n,S(a)]:null==n?function(){try{var n;return s&&(n=s.randomBytes)?n=n(l):(n=new Uint8Array(l),(f.crypto||f.msCrypto).getRandomValues(n)),S(n)}catch(n){var t=f.navigator,r=t&&t.plugins;return[+new Date,f,r,f.screen,S(a)]}}():n,3),o),u=new m(o);return e.int32=function(){return 0|u.g(4)},e.quick=function(){return u.g(4)/4294967296},e.double=e,j(S(u.S),a),(t.pass||r||function(n,t,r,e){return e&&(e.S&&v(e,u),n.state=function(){return v(u,{})}),r?(c[p]=n,t):n})(e,i,"global"in t?t.global:this==c,t.state)}function m(n){var t,r=n.length,u=this,e=0,o=u.i=u.j=0,i=u.S=[];for(r||(n=[r++]);e<l;)i[e]=e++;for(e=0;e<l;e++)i[e]=i[o=h&o+n[e%r]+(t=i[e])],i[o]=t;(u.g=function(n){for(var t,r=0,e=u.i,o=u.j,i=u.S;n--;)t=i[e=h&e+1],r=r*l+i[h&(i[e]=i[o=h&o+t])+(i[o]=t)];return u.i=e,u.j=o,r})(l)}function v(n,t){return t.i=n.i,t.j=n.j,t.S=n.S.slice(),t}function j(n,t){for(var r,e=n+"",o=0;o<e.length;)t[h&o]=h&(r^=19*t[h&o])+e.charCodeAt(o++);return S(t)}function S(n){return String.fromCharCode.apply(0,n)}if(j(c.random(),a),"object"==typeof module&&module.exports){module.exports=n;try{s=require("crypto")}catch(n){}}else"function"==typeof define&&define.amd?define(function(){return n}):c["seed"+p]=n}("undefined"!=typeof self?self:this,[],Math);

var gimme = document.getElementById('gimme');
var save = document.getElementById('save');
var seedtxt = document.getElementById('seedtxt');
var friend = document.getElementById('yournewbestfriend');
var friendcontainer = document.getElementById('friendcontainer');
var seedcontainer = document.getElementById('seedcontainer');
var friendReady = false;
var loaded = false;
seedtxt.disabled = true;
save.disabled = true;

function isMobileDevice() {
	return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function loadSVG() {
	document.getElementById('yournewbestfriend').addEventListener('load', function() {
		loaded = true;
		prepareColors();
		setColors();
	});

	if (loaded) {
		prepareColors();
		setColors();
	}
}

var letterCounter = 0;

function calcSeed() {
    seed = String(Math.floor(Math.random() * new Date().getTime())).toString();
	console.log(seed);
}

seedtxt.addEventListener('input', function() {
	clearTimeout(animationTimer);
	letterCounter += 1;
	console.log(seedtxt.value);
	(letterCounter % 2 == 0) ? friend.classList.add('rot8left') : friend.classList.add('rot8right');
	friend.addEventListener('animationend', function() {
		friend.classList.remove('rot8left');
		friend.classList.remove('rot8right');
	});
	seed = seedtxt.value
	loadSVG();
});


gimme.addEventListener('click', () => {
	seedcontainer.style.display = "block";
    gimme.innerHTML = "Give me another.";
	calcSeed()
    giveFriend();
});

function sendSVGToCanvas() {
    var svgString = new XMLSerializer().serializeToString(friend.contentDocument.querySelector('svg'));
    svgString = svgString.replace(/width="[\d\.]+"/g, 'width="720"');
    svgString = svgString.replace(/height="[\d\.]+"/g, 'height="720"');
	var img = new Image();
    img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
    var canvas = document.getElementById('canvas');
    canvas.width = 720;
    canvas.height = 720;
    var ctx = canvas.getContext('2d');
	
    img.onload = function() {
        ctx.drawImage(img, 0, 0);
        var text = 'Seed: ' + seed;
        var fontSize = 40;
        var x = canvas.width;
        var y = 5;
        ctx.font =  '600 40px Arial';
        ctx.letterSpacing = "4px";
        ctx.fillStyle = 'white';
        ctx.strokeStyle = 'black'; 
        ctx.lineWidth = 6;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'top';
        ctx.strokeText(text, x, y);
        ctx.fillText(text, x, y); 
		
		if (isMobileDevice() || /Firefox/i.test(navigator.userAgent)) { 
			var link = document.createElement('a');
			link.download = seed + '.png';
			canvas.toBlob(function(blob) {
				var link = document.createElement('a');
				link.href = URL.createObjectURL(blob);
				link.click();
			}, 'image/png');

		} else {
			canvas.toBlob(function(blob) {
				var item = new ClipboardItem({ 'image/png': blob });
				navigator.clipboard.write([item]).then(function() {
					alert('Your mare has been copied to the clipboard.\nSeed: ' + seed);
				}, function(error) {
					alert('Unable to copy image to clipboard:', error);
				});
			});
		}
    };
}

save.addEventListener('click', () => {
	sendSVGToCanvas(); 
});


function randomHexColorCode(seed) {
  Math.seedrandom(seed);
  let n = (Math.random() * 0xfffff * 1000000).toString(16);
  return '#' + n.slice(0, 6);
};


function LightenDarkenColor(col, amt) {
  
    var usePound = true;
  
    if (col[0] == "#") {
        col = col.slice(1);
        usePound = true;
    }
 
    var num = parseInt(col, 16);
 
    var r = ((num >> 16) + amt) < 0 ? 0 : ((num >> 16) + amt > 255 ? 255 : (num >> 16) + amt);
    var b = (((num >> 8) & 0x00FF) + amt) < 0 ? 0 : (((num >> 8) & 0x00FF) + amt > 255 ? 255 : ((num >> 8) & 0x00FF) + amt);
    var g = ((num & 0x0000FF) + amt) < 0 ? 0 : ((num & 0x0000FF) + amt > 255 ? 255 : (num & 0x0000FF) + amt);
 
    return (usePound ? "#" : "") + ((1 << 24) + (r << 16) + (b << 8) + g).toString(16).slice(1);
  
}
function prepareColors() { 
	eyeColor = randomHexColorCode(seed)

	maneBackColor = randomHexColorCode(seed + Math.random())
	maneBackColorDarktone 	= LightenDarkenColor(maneBackColor, -15)
	maneBackColorOutline     = LightenDarkenColor(maneBackColor, -35)
	
	maneFrontColor = randomHexColorCode(seed + Math.random())
	maneFrontColorOutline     = LightenDarkenColor(maneFrontColor, -35)

	bodyColor = randomHexColorCode(seed + Math.random())
	bodyColorOutline     = LightenDarkenColor(bodyColor, -65)
	bodyColorBack        = LightenDarkenColor(bodyColor, -32)
	bodyColorBackOutline = LightenDarkenColor(bodyColor, -75)
}

runs = 0;

function setColors() {
	randomAlicorn = Math.random();
	alicornChance = randomAlicorn < 0.0052;
	//alicornChance = 1;

	randomUnicorn = Math.random();
	unicornChance = (!alicornChance) && (randomUnicorn < 0.33); 

	randomPegasus = Math.random();
	pegasusChance = (!alicornChance) && (!unicornChance) && (randomPegasus < 0.33);

	randomScrunch = Math.random();
	scrunchChance = randomScrunch < 0.01;

	randomPuffyMane = Math.random();
	puffyManeChance = randomPuffyMane < 0.20;


	//console.log("Random Scrunch:", randomScrunch);
	//console.log("Random Alicorn:", randomAlicorn);
	//console.log("Random Unicorn:", randomUnicorn);
	//console.log("Random Pegasus:", randomPegasus);
	//console.log("Random puffymane:", randomPuffyMane);

	
	unicornPaths = [
		//for puffy
		"path54",
		"path53",
		"path52",
		"path51",
		
		//default, under mane
		"path51-8",
		"path52-0",
		"path53-2",
		"path54-0"
	]
	
	pegasusPaths = [
		"path16",
		"path17",
		"path20"
	]
	
	smilePaths = [
		"path40",
		"path41",
		"path42"
	]
	
	scrunchPaths = [
		"path63",
		"path64",
		"path65"
	]
	
	puffyManePaths = [
		"path92",
		"path93",
		"path90",
		"path91",
		"path68",
		"path90-4",
		"path9-6",
		"path10-5",
		"path8-8",
		
		"path54",
		"path53",
		"path52",
		"path51",
	]
	
	pointyManePaths = [
		"path59",
		"path58",
		"path56",
		"path55",
		"path50",
		"path49",
		"path45",
		"path43",
		"path4",
		"path5",
		"path6",
		"path7",
		
		"path51-8",
		"path52-0",
		"path53-2",
		"path54-0"
	]
	
	bodyPaths = [
		"path54",
		"path53",
		"path52",
		"path52-0",
		"path53-2",
		"path54-0",
		"path13",
		"path21",
		"path18",
		"path60",
		"path40",
		"path63",
		"path17",
		"path20",
		"path8",
	]
	
	bodyOutlinePaths = [
		"path51",
		"path51-8",
		"path12",
		"path41",
		"path42",
		"path64",
		"path65",
		"path11",
		"path27",
		"path16",
		"path14",
		"path61",
		"path62",
	]
	
	bodyDarkPaths = [
		"path9",
	]
	
	bodyOutlineDarkPaths = [
		"path10",
	]
	
	frontManePaths = [
		"path7",
		"path56",
		"path59",
	]
	
	frontManeOutlinePaths = [
		"path6",,
		"path55",
		"path58",
	]
	
	backManePaths = [
		"path8-8",
		"path5",
		"path50",
		"path45",
		"path91",
		"path93",
		"path68",
	]
	
	backManeDarktonePaths = [
		"path10-5",
	]
	
	backManeOutlinePaths = [
		"path9-6",
		"path43",
		"path49",
		"path4",
		"path90",
		"path92",
		"path90-4",
	]
	
	if (alicornChance) {
		alert("You found a rare alicorn! Make sure to preserve it for future studies.");
	}

	var paths = friend.contentDocument.querySelectorAll('[d]');

	paths.forEach(function(path) {
		if (bodyPaths.includes(path.id)) {
			path.style.setProperty('fill', bodyColor, 'important');		
		}		
		
		if (bodyDarkPaths.includes(path.id)) {
			path.style.setProperty('fill', bodyColorBack, 'important');		
		}	
		
		if (bodyOutlinePaths.includes(path.id)) {
			path.style.setProperty('fill', bodyColorOutline, 'important');		
		}	
		
		if (bodyOutlineDarkPaths.includes(path.id)) {
			path.style.setProperty('fill', bodyColorBackOutline, 'important');		
		}	
		
		if (frontManePaths.includes(path.id)) {
			path.style.setProperty('fill', maneFrontColor, 'important');
		}
		
		if (frontManeOutlinePaths.includes(path.id)){
			path.style.setProperty('fill', maneFrontColorOutline, 'important');
		}
		
		if (backManePaths.includes(path.id)) {
			path.style.setProperty('fill', maneBackColor, 'important');
		}
		
		if (backManeDarktonePaths.includes(path.id)) {
			path.style.setProperty('fill', maneBackColorDarktone, 'important');
		}

		if (backManeOutlinePaths.includes(path.id)) {
			path.style.setProperty('fill', maneBackColorOutline, 'important');
		}
		
		if (scrunchChance) {
			if (smilePaths.includes(path.id)) {
				path.style.display = 'none'; 
			}
			
			if (scrunchPaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		} else {
			if (scrunchPaths.includes(path.id)) {
				path.style.display = 'none'; 
			}
			
			if (smilePaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		}
		

		if (alicornChance) {
			if (unicornPaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
			
			if (pegasusPaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		} else if (pegasusChance) {
			if (pegasusPaths.includes(path.id)) {
				path.style.display = 'none'; 
			}
			
			if (unicornPaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		} else if (unicornChance) {
			if (unicornPaths.includes(path.id)) {
				path.style.display = 'none'; 
			}
			
			if (pegasusPaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		} else {
			if (unicornPaths.includes(path.id) || pegasusPaths.includes(path.id)) {
				path.style.display = 'none'; 
			}
		} 
		
		if (puffyManeChance) {
			if (pointyManePaths.includes(path.id)) {
				path.style.display = 'none'; 
			}

			if (puffyManePaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		} else if (!puffyManeChance){
			if (puffyManePaths.includes(path.id)) {
				path.style.display = 'none'; 
			}
			if (pointyManePaths.includes(path.id)) {
				path.style.display = 'inline'; 
			}
		}
		
	});
	
	var gradients = friend.contentDocument.querySelectorAll('linearGradient');

	gradients.forEach(function(gradient) {
		var stops = gradient.querySelectorAll('stop');
		stops.forEach(function(stop) {
			if (stop.getAttribute('stop-color') == 'red') {
				stop.setAttribute('stop-color', eyeColor);
			}
		});
	});
}



function giveFriend() { 
    if (!friendReady) {
		loadSVG();
		save.style.display = "inline-block";
		
        friend.style.display = "block";
        friendcontainer.style.display = "block";
		
		if (runs == 0) {
			friend.classList.add('zoomingIn', 'rot8in');
			friendcontainer.classList.add('zoomingIn');
			runs += 1;
		} else {
			friend.classList.add('zoomingIn', 'rot8infast');
		}

        friendReady = true;
		
       
		save.disabled = true;
		seedtxt.value = seed;
		seedtxt.disabled = true;
		gimme.disabled = true;
		animationTimer = setTimeout(() => {
			friendcontainer.classList.remove('zoomingIn');
			friend.classList.remove('zoomingIn', 'rot8in', 'rot8infast');
			save.disabled = false;
			gimme.disabled = false;
			seedtxt.value = seed;
			seedtxt.disabled = false;
		}, 1000);

	} else if (friendReady) {
		friend.classList.add('zoomingOut', 'rot8out');
		gimme.disabled = true;
		save.disabled = true;
		seedtxt.value = seed;
		seedtxt.disabled = true;
		friend.addEventListener('animationend', function() {
			friend.classList.remove('zoomingOut', 'rot8out');
			friendReady = false;
			giveFriend();
		}, { once: true });
	}
}
</script>
